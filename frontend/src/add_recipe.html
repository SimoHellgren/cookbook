<!DOCTYPE html>
<html>
  <head>
    <title>Add recipe - Cookbook</title>
    <link rel="stylesheet" href="index.css">
  </head>
  <body>
    <form id="recipeform">
      <label>
        Recipe name
        <input name="name">
      </label>

      <label>
        Servings
        <input name="servings" type="number">
      </label>

      <label>
        Tags
        <input name="tags">
      </label>

      <label>
        Method
        <textarea name="method"></textarea>
      </label>

      <table id="ingredients">
        <thead>
          <tr>
            <th>Ingredient</th>
            <th>Quantity</th>
            <th>Measure</th>
            <th>Optional</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      
      <template id="ingredientrow">
        <tr>
          <td><input name="ingredient"></td>
          <td><input name="quantity" type="number" step="0.01"></td>
          <td><input name="measure" placeholder="e.g. dl"></td>
          <td><input name="optional" type="checkbox"></td>
        </tr>
      </template>

      <button type="button" onclick="addRow()">Add row</button>
      <button type="submit">Submit</button>
    </form>

    <script>
      // state business
      let recipes = []
      let ingredients = []

      //constants
      const APIURL = "http://localhost:8000"

      //DOM
      let $form = document.getElementById("recipeform")
      let $table = document.getElementById("ingredients")
      let $tablebody = $table.querySelector("tbody")
      let $template = document.getElementById("ingredientrow");

      const addRow = () => {
        let row = $template.content.cloneNode(true);
        $tablebody.appendChild(row);

        //set ids
        let rows = [...$tablebody.children]

        rows.forEach((row, i) => {
          row.querySelectorAll("input").forEach(inp => inp.id = `${inp.name}_${i}`)
        })

      }

      const submitForm = async (ev) => {
        ev.preventDefault()
        const data = new FormData($form)
        
        //prepare recipe data
        const recipe_data = {
          name: data.get("name"),
          servings: data.get("servings"),
          tags: data.get("tags"),
          method: data.get("method")  
        }

        //prepare ingredient data       
        let rows = [...$tablebody.children]

        let recipeingredients = rows.map(row => {
          [ingredient, quantity, measure, optional] = row.querySelectorAll("input")
          
          return {
            ingredient: ingredient.value,
            quantity: quantity.value,
            measure: measure.value,
            optional: optional.checked
          }

        })

        //alert if recipe already exists
        if (recipes.find(r => r.name === recipe_data.name)) alert(`Recipe with name "${recipe_data.name}" already exists`)

       
        //missing ingredients
        const missing = recipeingredients.filter(ri => !ingredients.map(i => i.name).includes(ri.ingredient)).map(x => ({name: x.ingredient}))
        
        const [recipe, _] = await Promise.all([
          createRecipe(recipe_data),
          Promise.all(missing.map(createIngredient)).then(res => ingredients = ingredients.concat(...res))
        ])

        //create recipe ingredients
        const ri_data = await recipeingredients.map(ri => {
          return {
            recipe_id: recipe.id,
            ingredient_id: ingredients.find(i => i.name === ri.ingredient).id,
            quantity: ri.quantity,
            measure: ri.measure,
            optional: ri.optional
          }
        })
        
        await ri_data.forEach(createRecipeIngredient)
        $form.reset()
        $tablebody.innerHTML = ""
        addRow()
      }

      $form.onsubmit = submitForm
      addRow()


      const api = {
        get: (endpoint) => fetch(APIURL + endpoint).then(r => r.json()),
        post: (endpoint, data) => fetch(APIURL + endpoint, {
            method: "POST",
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
          }).then(r => r.json())
      }
      
      const createIngredient = async (data) => api.post("/ingredients", data)
      const createRecipe = async (data) => api.post("/recipes", data)
      const createRecipeIngredient = async (data) => api.post(`/recipes/${data.recipe_id}/ingredients`, data)

      //set up state
      api.get("/recipes")
        .then(data => recipes = data)
        .then(console.log("Recipes fetched successfully"))

      api.get("/ingredients")
        .then(data => ingredients = data)
        .then(console.log("Ingredients fetched successfully"))


    </script>
  </body>
</html>