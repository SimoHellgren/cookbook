<!DOCTYPE html>
<html>
  <head>
    <title>Mealplan - Cookbook</title>
    <link rel="stylesheet" href="index.css">
  </head>

  <body>
    <div>
      <h3>Filter dates</h3>
      <label>
        Start date
        <input type="date" id="start_date">
      </label>
      <label>
        End date
        <input type="date" id="end_date">
      </label>
    </div>
    <div>
      <form>
        <input type="button" value="Create more" onclick="openModalOverlay()">
      </form>
    </div>

    <div class="modal" id="modal">
      <div class="modal-header">
        <div class="title">Create mealplans</div>
        <button class="closebutton" onclick="closeModalOverlay()">&times</button>
      </div>
      <div class="modal-body">
        <form id="new-mealplan-form">
          <label>
              Start date
              <input type="date" name="start_date">
          </label>
          <label>
              End date (leave empty for single date)
              <input type="date" name="end_date">
          </label>
          <label>
              Meals (name;servings)
              <textarea name="meals">lunch;2
dinner;2</textarea>
          </label>
          <button type="button" onclick="createPlans()">Create mealplans</button>
        </form>
      </div>
    </div>
    <div id="overlay"></div>


    <div id="mealpan-container"></div>
    <div>
      <button type="button" id="savebutton" onclick="savePlans()">Save</button>
    </div>
    
    <script>
      const container = document.getElementById("mealpan-container")

      // event listener for dates
      const start_date = document.getElementById('start_date');
      const end_date = document.getElementById('end_date');

      plans = [];
      recipes = [];

      /**
       * function for creating individual mealcards which allow you to choose a recipe for said meal
      */
      const createMealCard = (data) => {
        let element = document.createElement('div')
        element.setAttribute('class', 'mealcard')
        element.setAttribute('data-date', data.date) // date stored as attr for later filtering
        element.setAttribute('id', data.id) // this is used in savePlans

        let header = document.createElement('div')
        header.setAttribute('class', 'mealcard-header')
        const servings = parseFloat(data.servings).toPrecision(1)
        header.textContent = `${data.date} ${data.name} (${servings})`

        let selector = document.createElement('select')
        selector.append(
          new Option("", null, true), // empty selection as the default
          ...recipes.map(r => new Option(r.name, r.id, false, false))
        )
        element.append(header, selector)

        selector.value = data.recipe_id

        return element
      }


      const renderPlans = () => {
        const start = start_date.value
        const end = end_date.value

        // hide plans if not between start and end dates
        container.childNodes.forEach(plan => {
          date = plan.getAttribute('data-date')
          plan.style.display = ((start ? date >= start : true) && (end ? date <= end : true)) ? "block" : "none"
        })
      }

      // event listeners to trigger rendering of mealplans whenver date range changes
      start_date.addEventListener('change', renderPlans);
      end_date.addEventListener('change', renderPlans);

      //overlay stuff
      const openModalOverlay = () => {
        let modal = document.getElementById("modal")
        let overlay= document.getElementById("overlay")

        modal.classList.add("active")
        overlay.classList.add("active")
      
      }

      const closeModalOverlay = () => {
        let modal = document.getElementById("modal")
        let overlay= document.getElementById("overlay")

        modal.classList.remove("active")
        overlay.classList.remove("active")
      }

      const getPlans = async () => {
        const response = await fetch('http://localhost:8000/mealplans');
        plans = await response.json();

        const elements = plans.sort((a, b) => b.date > a.date ? -1 : 1).map(createMealCard)
        container.append(...elements)
      }

      const getRecipes = async () => {
        const response = await fetch('http://localhost:8000/recipes');
        recipes = await response.json();
      }


      const initData = async () => {
        await getRecipes();
        await getPlans();
      }

      initData();

      const putPlan = async (data) => {
        const response = await fetch(
          `http://localhost:8000/mealplans/${data.id}`,
          {
            method: "PUT",
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
          }
        );

        return response.json()
      }

      const postPlan = async (data) => {
        const response = await fetch(
          `http://localhost:8000/mealplans/`,
          {
            method: "POST",
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
          }
        );

        return response.json()
      }

      const savePlans = () => {
        container.childNodes.forEach(p => {
          const plan_id = parseInt(p.getAttribute("id")); // rely on the mealcard's id being the the plan id
          const recipe_id = parseInt(p.getElementsByTagName("select").item(0).value);

          const plan = plans.find(p => p.id === plan_id);

          const new_plan = {
            ...plan,
            recipe_id: recipe_id
          }

          putPlan(new_plan)
            .then(data => console.log(data));
        })
      }

      const dateRange = (start, end) => {
        var arr = []
        for (d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) arr.push(new Date(d))
        return arr
      }

      const createPlans = () => {
        let form = document.getElementById("new-mealplan-form")
        let data = new FormData(form)
        sd = new Date(data.get("start_date"))
        ed = new Date(data.get("end_date"))
        meals = data.get("meals").split("\n").map(e => e.split(";"))

        if (isNaN(sd)) {
          alert("Please provide a start date")
          return
        }

        //default end date is start date
        ed = isNaN(ed) ? sd : ed

        let dates = dateRange(sd, ed).map(d => d.toISOString().slice(0,10))

        let plans = dates.map(datestring => {
          return meals.map(([meal, servings]) => ({
            date: datestring,
            name: meal,
            servings: servings
          }))
        }).flat()

        Promise.all(plans.map(postPlan))
          .then(data => plans = plans.concat(data))
          .then(renderPlans)

        closeModalOverlay() 
      }

    </script>

  </body>
</html>