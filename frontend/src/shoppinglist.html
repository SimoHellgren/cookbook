<!DOCTYPE html>
<html>
  <head>
    <title>Shopping List - Cookbook</title>
    <link rel="stylesheet" href="index.css">
  </head>

  <body>
    <form id="shoppinglistform">
      <label>
        Start date
        <input id="start_date" type="date" name="start_date">
      </label>
      <label>
        End date
        <input id="end_date" type="date" name="end_date">
      </label>
      <input type="submit">
    </form>
      
      <h1>Shopping list</h1>
      <ul id="shoppinglist">
      </ul>
      
      <script>
        state = {
          recipes: [],
          recipe_ingredients: [],
          mealplans: []
        }

        let $form = document.getElementById("shoppinglistform")
        let $shoppinglist = document.getElementById("shoppinglist")


        const getRecipeIngredients = async () => {
          const res = await fetch("http://localhost:8000/recipe_ingredients")
          const data = await res.json()
          return data
        }
        
        const getMealplans = async () => {
          const res = await fetch("http://localhost:8000/mealplans")
          const data = await res.json()
          return data
        }
        
        const getRecipes = async () => {
          const res = await fetch("http://localhost:8000/recipes")
          const data = await res.json()
          return data
        }

        const submitForm = ev => {
          ev.preventDefault()
          let data = new FormData($form)

          sd = new Date(data.get("start_date")).toISOString().slice(0,10)
          ed = new Date(data.get("end_date")).toISOString().slice(0,10)
          
          let meals = state.mealplans.filter(mp => sd <= mp.date && mp.date <= ed)

          
          let list = meals.map(meal => {
            let li = document.createElement("li")
            let recipe = state.recipes.find(r => r.id === meal.recipe_id)
            if (!recipe) return

            let ingredients = state.recipe_ingredients.filter(i => i.recipe_id === recipe.id)

            const scale = meal.servings / recipe.servings
            const scaled_ingredients = ingredients.map(ing => ({
              ...ing, quantity: ing.quantity * scale
            }))

            li.textContent = `${recipe.name} (${meal.name} ${meal.date}, ${meal.servings} servings)`
            
            let ul = document.createElement("ul")

            scaled_ingredients.forEach(ing => {
              let li = document.createElement("li")
              let text = `${ing.ingredient.name} ${ing.quantity}${ing.measure}`
              if (ing.optional) {text = `(${text})`}
              li.textContent = text
              ul.appendChild(li)
            })

            li.appendChild(ul)
            return li
          })
          
          $shoppinglist.replaceChildren(...list.filter(x => typeof x !== "undefined"))
        }

        $form.onsubmit = submitForm

        //set up state
        getMealplans().then(data => state.mealplans = data)
        getRecipes().then(data => state.recipes = data)
        getRecipeIngredients().then(data => state.recipe_ingredients = data)

      </script>
  </body>
</html>